<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jogo da EN2 ‚Äî A Grande Travessia de Portugal</title>

<style>
:root{
  --bg:#111;
  --text:#eee;
  --panel:#1c1c1c;
  --accent:#ff9800;
  --grey:#555;
  --green:#2ecc71;
  --red:#e53935;
}

#modalTitle{
  font-weight:bold;
  font-size:16px;
  margin-bottom:6px;
}

#modalText{
  font-size:15px;
  line-height:1.4;
}

#modalEffect{
  margin-top:10px;
  padding-top:8px;
  border-top:1px solid rgba(255,255,255,.25);
  font-weight:bold;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial, Helvetica, sans-serif;
}
h1{
  text-align:center;
  margin:20px 0;
}

/* LAYOUT PRINCIPAL */
.main{
  display:flex;
  justify-content:center;
  gap:24px;
  align-items:flex-start;
}

/* TABULEIRO */
.board-frame{
  width:1000px;
  height:750px;
  position:relative;
  overflow:hidden;
  border-radius:10px;
}
.board-img{
  position:absolute;
  inset:0;
  background:url("https://i.imgur.com/SgYhoY8.png") center/cover no-repeat;
}
.pawn{
  position:absolute;
  transform:translate(-50%,-50%);
  font-size:22px;
  pointer-events:none;
  display:none;
}

/* CONTROLOS */
.controls{
  text-align:center;
  margin:20px;
}
button{
  border:none;
  padding:10px 18px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{
  opacity:.5;
}
.hidden{
  display:none;
}

/* BOT√ïES PE√ïES */
.car{background:#e53935;color:#fff}
.bike{background:#fb8c00;color:#fff}
.moto{background:#222;color:#fff}
.walk{background:#2ecc71;color:#000}

/* PAINEL DE OBJETIVO */
#objectivePanel{
  width:300px;
  background:var(--panel);
  border-radius:16px;
  padding:12px;
  border:2px dashed #555;
}
.objective-title{
  color:var(--accent);
  font-weight:bold;
  margin-bottom:10px;
}
.obj-item{
  display:flex;
  gap:10px;
  margin-bottom:6px;
}
.marco{
  background:var(--grey);
  color:#fff;
  padding:4px 10px;
  border-radius:8px;
  min-width:64px;
  text-align:center;
  font-weight:bold;
}
.marco.done{
  background:var(--green);
}
.extra-title{
  margin:16px 0 8px 0;
  text-align:center;
  color:#bbb;
  font-size:13px;
  border-top:1px dashed #444;
  padding-top:8px;
}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
}
#modalBox{
  background:#222;
  padding:22px;
  border-radius:14px;
  width:420px;
  text-align:center;
}
#modalBox button{margin:6px}
.accept{background:var(--green);color:#000}
.decline{background:var(--red);color:#fff}
.eventGood{
  background:#243f2f;   /* verde suave */
  color:#fff;
}

#modalEffect{
  margin-top:10px;
  margin-bottom:12px;
  font-weight:bold;
  opacity:.9;
}

#modalBox.good{
  background:#2f5a46;   /* verde mais vivo, mas suave */
}

#modalBox.bad{
  background:#6a2f2f;   /* vermelho mais limpo, menos bordeaux */
}

/* destaque subtil do OK sem mudar a cor base */
#modalBox.good button.eventGood,
#modalBox.bad  button.eventBad{
  box-shadow:0 0 0 2px rgba(255,255,255,.15);
}

.eventBad{
  background:#4a2323;   /* vermelho suave */
  color:#fff;
}

/* P√ìDIO */
#podium{
  position:fixed;
  inset:0;
  background:#000c;
  display:none;
  overflow:auto;
  padding:40px;
}
.podium-box{
  display:flex;
  justify-content:center;
  align-items:flex-end;
  gap:30px;
  margin-bottom:40px;
}
.step{
  width:160px;
  border-radius:14px;
  text-align:center;
  padding:12px;
  color:#000;
}
.gold{background:#f5c400;height:220px}
.silver{background:#ccc;height:180px}
.bronze{background:#c68642;height:150px}
.step .emoji{font-size:30px}
.step .name{font-weight:bold;margin-top:6px}

/* CARTAS FINAIS */
.cards{
  display:flex;
  gap:20px;
  justify-content:center;
  flex-wrap:wrap;
}
.card{
  background:#1c1c1c;
  border:2px dashed #555;
  border-radius:14px;
  padding:12px;
  width:260px;
}

/* CARTA DE JOGO */
.game-card{
  background:#111;
  border:1px solid #444;
  border-radius:10px;
  padding:8px;
  margin-bottom:10px;
  font-size:13px;
}
.game-card .title{
  color:var(--accent);
  font-weight:bold;
  margin-bottom:6px;
  text-align:center;
}
.game-card .line{margin-bottom:4px}

/* ESTAT√çSTICAS */
.stats{
  margin-top:10px;
  font-size:13px;
  color:#ccc;
}
</style>
</head>

<body>

<h1>Jogo da EN2 ‚Äî A Grande Travessia de Portugal</h1>

<div class="main">
  <div class="board-frame" id="board">
    <div class="board-img"></div>
    <div class="pawn" id="pawn0">üöó</div>
    <div class="pawn" id="pawn1">üö¥</div>
    <div class="pawn" id="pawn2">üèçÔ∏è</div>
    <div class="pawn" id="pawn3">üö∂</div>
  </div>
  <div id="objectivePanel" class="hidden"></div>
</div>

<div class="controls">
  <div id="setup">
    Jogadores:
    <select id="playerCount">
      <option>1</option><option>2</option><option>3</option><option>4</option>
    </select>
    <button id="startBtn">COME√áAR</button>
  </div>

  <div id="names" class="hidden"></div>

  <div id="game" class="hidden">
    <button id="rollBtn">JOGAR</button>
    üé≤ <span id="dice">‚Äî</span>
    <p id="turn"></p>
  </div>
</div>

<div id="modal">
  <div id="modalBox">
  <div id="modalTitle"></div>
  <p id="modalText"></p>
  <div id="modalEffect"></div>
  <div id="modalButtons"></div>
</div>
</div>

<div id="podium"></div>

<script>

/* ================= SPACES ================= */
const SPACES = [
{"x":0.09165302782324058,"y":0.11379397834912044},
{"x":0.0867430441898527,"y":0.16250845737483086},
{"x":0.0867430441898527,"y":0.2152824763193505},
{"x":0.09165302782324058,"y":0.2700862652232747},
{"x":0.127114020731042,"y":0.23558017591339647},
{"x":0.15057283142389524,"y":0.18957205683355888},
{"x":0.17621385706492088,"y":0.14356393775372125},
{"x":0.21876704855428258,"y":0.11311738836265224},
{"x":0.26513911620294595,"y":0.09417286874154264},
{"x":0.30551009274413526,"y":0.10229194857916103},
{"x":0.3458810692853246,"y":0.13003213802435723},
{"x":0.35951991271140205,"y":0.17671684709066307},
{"x":0.3246044735406437,"y":0.21595906630581868},
{"x":0.287506819421713,"y":0.19227841677943167},
{"x":0.24277141298417892,"y":0.17198071718538568},
{"x":0.2198581560283688,"y":0.21798883626522328},
{"x":0.23840698308783415,"y":0.2700862652232747},
{"x":0.22804146208401527,"y":0.31880074424898514},
{"x":0.18112384069830878,"y":0.3269198240866035},
{"x":0.13911620294599017,"y":0.33571549391069017},
{"x":0.11292962356792144,"y":0.38713633288227334},
{"x":0.11947626841243862,"y":0.4372039918809202},
{"x":0.15711947626841244,"y":0.4690037212449256},
{"x":0.20021822149481724,"y":0.45005920162381596},
{"x":0.23404255319148934,"y":0.41217016238159676},
{"x":0.2613202400436443,"y":0.368868403247632},
{"x":0.2940534642662302,"y":0.3275964140730717},
{"x":0.3333333333333333,"y":0.2998562246278755},
{"x":0.37861429350791054,"y":0.3181241542625169},
{"x":0.4026186579378069,"y":0.3600727334235454},
{"x":0.40698308783415166,"y":0.41961265223274696},
{"x":0.3824331696672122,"y":0.4554719215155616},
{"x":0.3376977632296781,"y":0.4893014208389716},
{"x":0.2967812329514457,"y":0.5048629905277402},
{"x":0.2509547190398254,"y":0.5190713802435725},
{"x":0.20403709765411893,"y":0.5501945196211097},
{"x":0.1756683033278778,"y":0.5887601488497971},
{"x":0.18876159301691217,"y":0.6455937077131259},
{"x":0.23349699945444624,"y":0.6652148173207038},
{"x":0.27714129841789414,"y":0.6516830175913396},
{"x":0.3175122749590834,"y":0.6313853179972937},
{"x":0.35951991271140205,"y":0.6070280784844384},
{"x":0.4004364429896345,"y":0.5725219891745602},
{"x":0.42825968357883254,"y":0.5420754397834913},
{"x":0.4653573376977632,"y":0.5014800405953992},
{"x":0.4915439170758319,"y":0.46765054127198924},
{"x":0.5237315875613747,"y":0.4290849120433018},
{"x":0.5613747954173486,"y":0.40269790257104193},
{"x":0.5990180032733223,"y":0.36345568335588635},
{"x":0.6377523186033823,"y":0.34045162381596755},
{"x":0.6824877250409165,"y":0.32489005412719896},
{"x":0.7255864702673214,"y":0.33639208389715836},
{"x":0.7408619749045281,"y":0.385783152909337},
{"x":0.7097654118930714,"y":0.433144451962111},
{"x":0.6715766503000545,"y":0.46359100135318},
{"x":0.629569012547736,"y":0.4865950608930988},
{"x":0.5881069285324604,"y":0.5116288903924222},
{"x":0.552645935624659,"y":0.5434286197564276},
{"x":0.5280960174577196,"y":0.5806410690121786},
{"x":0.5302782324058919,"y":0.642210757780785},
{"x":0.5575559192580469,"y":0.6861891069012179},
{"x":0.5995635570103655,"y":0.6949847767253045},
{"x":0.6415711947626841,"y":0.6713041271989174},
{"x":0.668848881614839,"y":0.6246194181326117},
{"x":0.6972176759410802,"y":0.5779347090663058},
{"x":0.729950900163666,"y":0.5319265899864682},
{"x":0.7665030005455538,"y":0.5068927604871448},
{"x":0.8090561920349154,"y":0.534632949932341},
{"x":0.8199672667757774,"y":0.5860537889039242},
{"x":0.7948717948717948,"y":0.6408575778078485},
{"x":0.7495908346972177,"y":0.6516830175913396},
{"x":0.7054009819967266,"y":0.66656799729364},
{"x":0.7092198581560283,"y":0.7132527063599459},
{"x":0.7277686852154936,"y":0.7667033152909337},
{"x":0.7026732133115112,"y":0.8194773342354534},
{"x":0.6623022367703219,"y":0.801209404600812},
{"x":0.6126568466993999,"y":0.7768521650879567},
{"x":0.5859247135842881,"y":0.8194773342354534},
{"x":0.6099290780141844,"y":0.8688684032476319},
{"x":0.6486633933442444,"y":0.8898426928281462},
{"x":0.6912165848336062,"y":0.8918724627875507},
{"x":0.7424986361156574,"y":0.8715747631935048},
{"x":0.7801418439716311,"y":0.8330091339648173},
{"x":0.7997817785051827,"y":0.7863244248985116},
{"x":0.8145117294053463,"y":0.7396397158322058},
{"x":0.8521549372613202,"y":0.6902486468200271},
{"x":0.8696126568466993,"y":0.7477587956698242},
{"x":0.8908892525913802,"y":0.7897073748308525},
{"x":0.9078014184397163,"y":0.8478941136671179},
{"x":0.8979814511729405,"y":0.902697902571042}
];

/* ================= MUNIC√çPIOS (BASE EST√ÅVEL) ================= */
const MUNICIPIO_NOME = {
  0:"Chaves",
  35:"Vila Pouca de Aguiar",
  64:"Vila Real",
  69:"Km 69",
  81:"Santa Marta de Penagui√£o",
  88:"Peso da R√©gua",
  104:"Lamego",
  136:"Castro Daire",
  152:"S√£o Pedro do Sul",
  171:"Viseu",
  200:"Tondela",
  213:"Santa Comba D√£o",
  225:"Mort√°gua",
  238:"Penacova",
  248:"Vila Nova de Poiares",
  262:"Lous√£",
  272:"G√≥is",
  324:"Pedr√≥g√£o Grande",
  345:"Sert√£",
  366:"Vila de Rei",
  369:"Meio da EN2",
  386:"Sardoal",
  400:"Abrantes",
  435:"Ponte de S√¥r",
  466:"Avis",
  475:"Mora",
  494:"Coruche",
  500:"Ciborro",
  518:"Montemor-o-Novo",
  551:"Alc√°√ßovas",
  565:"Torr√£o",
  595:"Ferreira do Alentejo",
  619:"Aljustrel",
  640:"Castro Verde",
  663:"Almod√¥var",
  666:"Km 666",
  688:"Ameixial",
  722:"S√£o Br√°s de Alportel",
  738:"Faro",
  738.5:"Faro (Final)"
};

/* ================= KM POR CASA ================= */
const KM_BY_INDEX = {
  3:0,5:35,7:64,8:69,11:81,13:88,16:104,19:136,21:152,
  23:171,25:200,27:213,29:225,31:238,33:248,35:262,
  37:272,39:324,41:345,43:366,44:369,46:386,48:400,
  50:435,52:466,54:475,57:494,58:500,60:518,63:551,
  66:565,68:595,70:619,73:640,75:663,77:666,80:688,
  83:722,85:738,89:738.5
};

const KM_TO_INDEX = {};
Object.entries(KM_BY_INDEX).forEach(([idx, km])=>{
  KM_TO_INDEX[km] = Number(idx);
});

const SPECIAL_CELLS = {};
Object.keys(KM_BY_INDEX).forEach(i=>{
  SPECIAL_CELLS[i] = { km: KM_BY_INDEX[i], final: i == 89 };
});

/* ================= EVENTOS ================= */
const EVENTS = [

  {
    title:"Nem tudo na viagem corre bem‚Ä¶",
    text:"Furo no pneu em Santa Marta de Penagui√£o.",
    effect:"Recua 1 casa.",
    move:-1,
    cls:"eventBad"
  },

  {
    title:"Nem tudo na viagem corre bem‚Ä¶",
    text:"A tua mota ficou sem gasolina.",
    effect:"Recua 2 casas.",
    move:-2,
    cls:"eventBad"
  },

  {
    title:"Bons momentos!",
    text:"Estrada livre, bom ritmo.",
    effect:"Avan√ßa +1 casa.",
    move:1,
    cls:"eventGood"
  },

  {
    title:"Bons momentos!",
    text:"Paisagem inspiradora.",
    effect:"Avan√ßa +2 casas.",
    move:2,
    cls:"eventGood"
  },

  {
    title:"Bons momentos!",
    text:"Seguiste pela rota mais fluida.",
    effect:"Avan√ßa at√© ao Km 200 (Tondela).",
    goKm:200,
    cls:"eventGood"
  },

  {
    title:"Bons momentos!",
    text:"Chegaste ao ponto simb√≥lico da viagem.",
    effect:"Avan√ßa at√© ao Km 369 (Meio da EN2).",
    goKm:369,
    cls:"eventGood"
  },
/* ==== EVENTOS GLOBAIS ==== */

  {
    title:"Nem tudo na viagem corre bem‚Ä¶",
    text:"Mau tempo em todo o pa√≠s.",
    effect:"Todos os jogadores recuam 1 casa.",
    move:-1,
    all:true,
    cls:"eventBad"
  },

  {
    title:"Bons momentos!",
    text:"Tr√¢nsito fluido em toda a EN2.",
    effect:"Todos os jogadores avan√ßam 1 casa.",
    move:1,
    all:true,
    cls:"eventGood"
  },

  {
    title:"Nem tudo na viagem corre bem‚Ä¶",
    text:"Arrast√£o da Grande Pedra em Vila Pouca de Aguiar.",
    effect:"Todos os jogadores v√£o para Vila Pouca de Aguiar (Km 35).",
    goKm:35,
    all:true,
    cls:"eventBad"
  }

];


/* ================= PERGUNTAS ================= */
const QUESTIONS = [
  "Qual √© o prato t√≠pico mais famoso de Portugal?",
  "Em que ano foi inaugurada a EN2?",
  "Qual √© o rio mais longo de Portugal?",
  "Portugal tem quantos distritos?",
  "Qual √© a capital do Algarve?"
];

/* ================= OBJETIVOS (13 TOTAIS) ================= */
const OBJECTIVES = [

/* 1 */
{ items:[
  {km:0,text:"Visitar Chaves"},
  {km:200,text:"Visitar Tondela"},
  {km:400,text:"Visitar Abrantes"},
  {km:500,text:"Visitar Ciborro"},
  {km:738,text:"Chegar a Faro"}
]},

/* 2 */
{ items:[
  {km:35,text:"Visitar Vila Pouca de Aguiar"},
  {km:171,text:"Visitar Viseu"},
  {km:272,text:"Visitar G√≥is"},
  {km:551,text:"Visitar Alc√°√ßovas"},
  {km:722,text:"Visitar S√£o Br√°s de Alportel"}
]},

/* 3 */
{ items:[
  {km:64,text:"Visitar Vila Real"},
  {km:213,text:"Visitar Santa Comba D√£o"},
  {km:345,text:"Visitar Sert√£"},
  {km:565,text:"Visitar Torr√£o"},
  {km:688,text:"Visitar Ameixial"}
]},

/* 4 */
{ items:[
  {km:152,text:"Visitar S√£o Pedro do Sul"},
  {km:324,text:"Visitar Pedr√≥g√£o Grande"},
  {km:466,text:"Visitar Avis"},
  {km:518,text:"Visitar Montemor-o-Novo"},
  {km:663,text:"Visitar Almod√¥var"}
]},

/* 5 */
{ items:[
  {km:81,text:"Visitar Santa Marta de Penagui√£o"},
  {km:225,text:"Visitar Mort√°gua"},
  {km:345,text:"Visitar Sert√£"},
  {km:595,text:"Visitar Ferreira do Alentejo"},
  {km:738,text:"Chegar a Faro"}
]},

/* 6 */
{ items:[
  {km:88,text:"Visitar Peso da R√©gua"},
  {km:238,text:"Visitar Penacova"},
  {km:366,text:"Visitar Vila de Rei"},
  {km:619,text:"Visitar Aljustrel"},
  {km:738.5,text:"Chegar a Faro (Final)"}
]},

/* 7 */
{ items:[
  {km:104,text:"Visitar Lamego"},
  {km:248,text:"Visitar Vila Nova de Poiares"},
  {km:386,text:"Visitar Sardoal"},
  {km:640,text:"Visitar Castro Verde"},
  {km:738,text:"Chegar a Faro"}
]},

/* 8 */
{ items:[
  {km:136,text:"Visitar Castro Daire"},
  {km:262,text:"Visitar Lous√£"},
  {km:435,text:"Visitar Ponte de S√¥r"},
  {km:666,text:"Passar pelo Km 666"},
  {km:738.5,text:"Chegar a Faro (Final)"}
]},

/* 9 */
{ items:[
  {km:0,text:"Partir de Chaves"},
  {km:369,text:"Chegar ao Meio da Estrada"},
  {km:738,text:"Chegar a Faro"},
  {km:738.5,text:"Chegar a Faro (Final)"}
]},

/* 10 */
{ items:[
  {km:0,text:"Partir de Chaves"},
  {km:738,text:"Chegar a Faro"}
]},

/* 11 */
{ items:[
  {km:69,text:"Passar pelo Km 69"},
  {km:369,text:"Chegar ao Meio da Estrada"},
  {km:475,text:"Visitar Mora"},
  {km:494,text:"Visitar Coruche"},
  {km:738,text:"Chegar a Faro"}
]},

/* 12 ‚Äî OBJETIVO ESPECIAL */
{ special:true, type:"first", text:"Ser o PRIMEIRO a chegar a Faro (Km 738,5)" },

/* 13 ‚Äî OBJETIVO ESPECIAL */
{ special:true, type:"last", text:"Ser o √öLTIMO a chegar a Faro (Km 738,5)" }

];

/* ================= JOGADORES ================= */
const pawns = [pawn0, pawn1, pawn2, pawn3];
let players = [];
let current = 0;

/* ================= POSICIONAR PE√ÉO ================= */
function placePawn(pawn, i){
  const s = SPACES[i];
  let ox = -8, oy = -10;
  if(i===80){ox=-18;oy=-14}
  if(i===83){ox=-16;oy=-18}
  if(i===85){ox=-12;oy=-20}
  if(i===89){ox=-10;oy=-22}
  pawn.style.left = (s.x * board.clientWidth + ox) + "px";
  pawn.style.top  = (s.y * board.clientHeight + oy) + "px";
}

/* ================= MODAL ================= */
function showModal(card, buttons){
  modalButtons.innerHTML = "";

  modalBox.className = "";
  modalBox.classList.add(card.cls);

  modalText.innerHTML = `
    <div style="font-weight:bold;margin-bottom:8px">${card.title}</div>
    <div style="margin-bottom:8px">${card.text}</div>
    <div style="opacity:.9">${card.effect}</div>
  `;

  buttons.forEach(b=>{
    const btn = document.createElement("button");
    btn.textContent = b.text;
    btn.className = b.cls || "";
    btn.onclick = b.action;
    modalButtons.appendChild(btn);
  });

  modal.style.display = "flex";
}

function closeModal(){
  modal.style.display = "none";
}

/* ================= SETUP ================= */
startBtn.onclick = ()=>{
  setup.classList.add("hidden");
  names.classList.remove("hidden");

  let total = Number(playerCount.value);
  let i = 0;
  let used = [];

  function nextPlayer(){
    names.innerHTML = "";

    if(i >= total){
      const deck = [...OBJECTIVES].sort(()=>Math.random()-0.5);
      players.forEach(p=>p.objective = deck.pop());
      names.classList.add("hidden");
      game.classList.remove("hidden");
      objectivePanel.classList.remove("hidden");
      updateTurn();
      return;
    }

    const input = document.createElement("input");
    input.placeholder = "Nome do Jogador";

    names.append(
      "Jogador " + (i+1),
      document.createElement("br"),
      input,
      document.createElement("br")
    );

    [
      {id:0,cls:"car",txt:"üöó Carro"},
      {id:1,cls:"bike",txt:"üö¥ Bicicleta"},
      {id:2,cls:"moto",txt:"üèçÔ∏è Mota"},
      {id:3,cls:"walk",txt:"üö∂ A p√©"}
    ].forEach(p=>{
      if(used.includes(p.id)) return;

      const b = document.createElement("button");
      b.className = p.cls;
      b.textContent = p.txt;

      b.onclick = ()=>{
        used.push(p.id);
        players.push({
          name: input.value || ("Jogador "+(i+1)),
          pawn: p.id,
          pos: 0,
          done: {},
          extra: [],
          municipiosVisitados: 0,
          questionsCorrect: 0,
          questionsWrong: 0,
          finished: false,
          order: 0
        });
        pawns[p.id].style.display = "block";
        placePawn(pawns[p.id],0);
        i++;
        nextPlayer();
      };

      names.appendChild(b);
    });
  }

  nextPlayer();
};

/* ================= TURNO ================= */
function updateTurn(){
  if(players.every(p=>p.finished)){
    showPodium();
    return;
  }

  const p = players[current];

  if(p.skip){
    p.skip--;
    current = (current+1) % players.length;
    updateTurn();
    return;
  }

  turn.textContent = "Vez de " + p.name;
  renderObjective(p);
}

/* ================= OBJETIVO ================= */
function renderObjective(p){
  objectivePanel.innerHTML = `<div class="objective-title">üéØ Objetivo de ${p.name}</div>`;

  if(p.objective.special){
    objectivePanel.innerHTML += `
      <div class="obj-item">
        <div class="marco">FINAL</div>
        <div>${p.objective.text}</div>
      </div>`;
  } else {
    p.objective.items.forEach(it=>{
      objectivePanel.innerHTML += `
        <div class="obj-item">
          <div class="marco ${p.done[it.km]?"done":""}">Km ${it.km}</div>
          <div>${it.text}</div>
        </div>`;
    });
  }

  if(p.extra.length){
    objectivePanel.innerHTML += `<div class="extra-title">Outras fichas</div>`;
    p.extra.forEach(km=>{
      objectivePanel.innerHTML += `
        <div class="obj-item">
          <div class="marco">Km ${km}</div>
          <div>Visitar ${MUNICIPIO_NOME[km]}</div>
        </div>`;
    });
  }
}

/* ================= PERGUNTA ================= */
function askQuestion(cell){
  showModal(
    QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)],
    [
      {
        text:"Resposta Certa",
        cls:"accept",
        action:()=>{
          players[current].questionsCorrect++;
          closeModal();
          askFicha(cell); // üîπ CONTINUA SEMPRE
        }
      },
      {
        text:"Resposta Errada",
        cls:"decline",
        action:()=>{
          players[current].questionsWrong++;
          closeModal();
          current = (current+1) % players.length;
          updateTurn();
        }
      }
    ]
  );
}

/* ================= FICHA (CORRIGIDO) ================= */
function askFicha(cell){
  const nome = MUNICIPIO_NOME[cell.km] || `Km ${cell.km}`;

  showModal(
    `${players[current].name} ganhou a ficha ${nome}. Aceita?`,
    [
      {
        text:"Aceitar",
        cls:"accept",
        action:()=>{
          closeModal();
          const p = players[current];
          p.municipiosVisitados++;

          if(!p.objective.special && p.objective.items.some(it=>it.km===cell.km)){
            p.done[cell.km] = true;
          } else {
            p.extra.push(cell.km);
          }

          if(cell.final){
            p.finished = true;
            p.order = players.filter(x=>x.finished).length;
          }

          // üî• CONTINUA A JOGAR
          updateTurn();
        }
      },
      {
  text:"Recusar",
  cls:"decline",
  action:()=>{
    closeModal();
    const p = players[current];

    if(cell.final){
      p.finished = true;
      p.order = players.filter(x=>x.finished).length;
    }

    updateTurn();
  }
}
    ]
  );
}

/* ================= EVENTO ================= */
async function doEvent(){
  const ev = EVENTS[Math.floor(Math.random()*EVENTS.length)];

  showModal(ev,[{
    text:"OK",
    cls:ev.cls,
    action: async ()=>{
      closeModal();

      const targets = ev.all ? players : [players[current]];

      for(const p of targets){

        // perder turnos
        if(ev.skip){
          p.skip = (p.skip || 0) + ev.skip;
          continue;
        }

        // ir para Km espec√≠fico
        if(ev.goKm !== undefined){
          const idx = Object.keys(SPECIAL_CELLS)
            .find(i => SPECIAL_CELLS[i].km === ev.goKm);
          if(idx !== undefined){
            p.pos = Number(idx);
            placePawn(pawns[p.pawn], p.pos);
          }
          continue;
        }

        // mover casas
        if(ev.move){
          let target = p.pos + ev.move;
          if(target < 0) target = 0;
          if(target > SPACES.length-1) target = SPACES.length-1;

          while(p.pos !== target){
            p.pos += p.pos < target ? 1 : -1;
            placePawn(pawns[p.pawn], p.pos);
            await new Promise(r=>setTimeout(r,300));
          }
        }
      }

      current = (current+1) % players.length;
      updateTurn();
    }
  }]);
}

/* ================= JOGAR ================= */
rollBtn.onclick = async ()=>{
  const r = Math.floor(Math.random()*6)+1;
  dice.textContent = r;

  const p = players[current];
  let target = p.pos + r;
  const LAST = SPACES.length-1;

  if(target > LAST){
    target = LAST - (target - LAST);
  }

  while(p.pos !== target){
    p.pos += p.pos < target ? 1 : -1;
    placePawn(pawns[p.pawn], p.pos);
    await new Promise(res=>setTimeout(res,300));
  }

  const idx = p.pos;
  const cell = SPECIAL_CELLS[idx];

  if(idx < 3){
    current = (current+1) % players.length;
    updateTurn();
  }
  else if(cell){
    askQuestion(cell);
  }
  else if(idx < 85){
    doEvent();
  }
  else{
    current = (current+1) % players.length;
    updateTurn();
  }

 };

/* ================= P√ìDIO FINAL ================= */
function showPodium(){
  podium.style.display = "block";
  game.classList.add("hidden");

  const firstObj = players.find(p=>p.objective.special && p.objective.type==="first");
  const lastObj  = players.find(p=>p.objective.special && p.objective.type==="last");
  const finished = players.filter(p=>p.finished).sort((a,b)=>a.order-b.order);

  if(firstObj && finished[0] === firstObj) firstObj.doneFinal = true;
  if(lastObj && finished[finished.length-1] === lastObj) lastObj.doneFinal = true;

  const ranked = [...players].sort((a,b)=>{
    const oa = Object.keys(a.done).length + (a.doneFinal?1:0);
    const ob = Object.keys(b.done).length + (b.doneFinal?1:0);
    if(ob!==oa) return ob-oa;
    return a.order - b.order;
  });

  podium.innerHTML = `
  <div class="podium-box">
    ${ranked[1]?`<div class="step silver"><div class="emoji">${pawns[ranked[1].pawn].textContent}</div><div class="name">${ranked[1].name}</div></div>`:""}
    <div class="step gold"><div class="emoji">${pawns[ranked[0].pawn].textContent}</div><div class="name">${ranked[0].name}</div></div>
    ${ranked[2]?`<div class="step bronze"><div class="emoji">${pawns[ranked[2].pawn].textContent}</div><div class="name">${ranked[2].name}</div></div>`:""}
  </div>

  <div class="cards">
  ${ranked.map(p=>`
    <div class="card">
      <div class="objective-title">üé¥ Carta de Jogo ‚Äî ${p.name}</div>

      ${
        p.objective.special
        ? `<div class="obj-item">
            <div class="marco ${p.doneFinal?"done":""}">FINAL</div>
            <div>${p.objective.text}</div>
          </div>`
        : p.objective.items.map(it=>`
            <div class="obj-item">
              <div class="marco ${p.done[it.km]?"done":""}">Km ${it.km}</div>
              <div>${it.text}</div>
            </div>`).join("")
      }

      ${p.extra.length?`<div class="extra-title">Outras fichas</div>`:""}
      ${p.extra.map(km=>`
        <div class="obj-item">
          <div class="marco">Km ${km}</div>
          <div>Visitar ${MUNICIPIO_NOME[km]}</div>
        </div>`).join("")}

      <div class="stats">
        üèòÔ∏è Munic√≠pios: ${p.municipiosVisitados}<br>
        ‚ùì Certas: ${p.questionsCorrect}<br>
        ‚ùå Erradas: ${p.questionsWrong}
      </div>
    </div>
  `).join("")}
  </div>`;
}
</script>
</body>
</html>
