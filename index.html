<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jogo da EN2 ‚Äî A Grande Travessia de Portugal</title>

<style>
:root{
  --bg:#111;
  --text:#eee;
  --panel:#1c1c1c;
  --grey:#444;
  --green:#2ecc71;
  --accent:#ff9800;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:Arial}
h1{text-align:center;margin:20px 0}
.main{display:flex;justify-content:center;gap:24px}

/* TABULEIRO */
.board-frame{
  width:1000px;height:750px;
  position:relative;overflow:hidden;border-radius:10px
}
.board-img{
  position:absolute;inset:0;
  background:url("https://i.imgur.com/SgYhoY8.png") center/cover no-repeat
}
.pawn{
  position:absolute;
  transform:translate(-50%,-50%);
  font-size:22px;
  pointer-events:none;
  display:none
}
.debug-index{
  position:absolute;bottom:6px;right:8px;
  background:#000;color:#0f0;
  font-size:11px;padding:3px 6px;border-radius:6px
}

/* CONTROLOS */
.controls{text-align:center;margin:20px}
button{
  border:none;padding:10px 18px;border-radius:10px;
  font-weight:bold;cursor:pointer
}
button:disabled{opacity:.4}
.hidden{display:none}
.rules-btn{background:#666;margin-left:10px}

/* OBJETIVOS */
#objectivePanel{
  width:300px;background:var(--panel);
  border-radius:16px;padding:12px;
  border:2px dashed #555;align-self:flex-start
}
.objective-title{color:var(--accent);font-weight:bold;margin-bottom:10px}
.obj-item{display:flex;gap:10px;margin-bottom:6px}
.marco{
  background:var(--grey);color:#fff;
  padding:4px 10px;border-radius:8px;
  min-width:64px;text-align:center;font-weight:bold
}
.marco.done{background:var(--green)}
.extra-title{margin-top:12px;color:#aaa;font-size:13px}

/* PE√ïES */
.pawn-select button{margin:6px}
.car{background:red}
.bike{background:orange}
.moto{background:#333;color:#fff}
.walk{background:lime}

/* MODAL */
#modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center
}
#modalBox{
  background:#222;padding:20px;
  border-radius:12px;width:360px;text-align:center
}
#modalBox button{margin:6px}

/* FINAL */
#finalScreen{
  position:fixed;inset:0;
  background:#000;
  color:#fff;
  display:none;
  padding:40px;
  overflow:auto
}
</style>
</head>

<body>

<h1>Jogo da EN2 ‚Äî A Grande Travessia de Portugal</h1>

<div class="main">
  <div class="board-frame" id="board">
    <div class="board-img"></div>
    <div class="pawn" id="pawn0">üöó</div>
    <div class="pawn" id="pawn1">üö¥</div>
    <div class="pawn" id="pawn2">üèçÔ∏è</div>
    <div class="pawn" id="pawn3">üö∂</div>
    <div id="debugIndex" class="debug-index">Index: ‚Äî</div>
  </div>
  <div id="objectivePanel" class="hidden"></div>
</div>

<div class="controls">
  <div id="setup">
    Jogadores:
    <select id="playerCount">
      <option>1</option><option>2</option><option>3</option><option>4</option>
    </select>
    <button id="startBtn">COME√áAR</button>
    <button id="rulesBtn" class="rules-btn">REGRAS</button>
  </div>

  <div id="names" class="hidden"></div>

  <div id="game" class="hidden">
    <button id="rollBtn">JOGAR</button>
    üé≤ <span id="dice">‚Äî</span>
    <p id="turn"></p>
  </div>
</div>

<div id="modal">
  <div id="modalBox">
    <p id="modalText"></p>
    <button id="rightBtn">Resposta Certa</button>
    <button id="wrongBtn">Resposta Errada</button>
  </div>
</div>

<div id="finalScreen"></div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* -------- REGRAS -------- */
rulesBtn.onclick=()=>window.open("regras.html","_blank");

/* -------- PERGUNTAS ALEAT√ìRIAS -------- */
const QUESTIONS=[
 "Qual √© o prato t√≠pico mais famoso de Portugal?",
 "Em que ano foi inaugurada a EN2?",
 "Qual √© o rio mais longo de Portugal?",
 "Portugal tem quantos distritos?",
 "Qual √© a capital do Algarve?"
];

/* TABULEIRO */
const SPACES = [
{"x":0.09165302782324058,"y":0.11379397834912044},
{"x":0.0867430441898527,"y":0.16250845737483086},
{"x":0.0867430441898527,"y":0.2152824763193505},
{"x":0.09165302782324058,"y":0.2700862652232747},
{"x":0.127114020731042,"y":0.23558017591339647},
{"x":0.15057283142389524,"y":0.18957205683355888},
{"x":0.17621385706492088,"y":0.14356393775372125},
{"x":0.21876704855428258,"y":0.11311738836265224},
{"x":0.26513911620294595,"y":0.09417286874154264},
{"x":0.30551009274413526,"y":0.10229194857916103},
{"x":0.3458810692853246,"y":0.13003213802435723},
{"x":0.35951991271140205,"y":0.17671684709066307},
{"x":0.3246044735406437,"y":0.21595906630581868},
{"x":0.287506819421713,"y":0.19227841677943167},
{"x":0.24277141298417892,"y":0.17198071718538568},
{"x":0.2198581560283688,"y":0.21798883626522328},
{"x":0.23840698308783415,"y":0.2700862652232747},
{"x":0.22804146208401527,"y":0.31880074424898514},
{"x":0.18112384069830878,"y":0.3269198240866035},
{"x":0.13911620294599017,"y":0.33571549391069017},
{"x":0.11292962356792144,"y":0.38713633288227334},
{"x":0.11947626841243862,"y":0.4372039918809202},
{"x":0.15711947626841244,"y":0.4690037212449256},
{"x":0.20021822149481724,"y":0.45005920162381596},
{"x":0.23404255319148934,"y":0.41217016238159676},
{"x":0.2613202400436443,"y":0.368868403247632},
{"x":0.2940534642662302,"y":0.3275964140730717},
{"x":0.3333333333333333,"y":0.2998562246278755},
{"x":0.37861429350791054,"y":0.3181241542625169},
{"x":0.4026186579378069,"y":0.3600727334235454},
{"x":0.40698308783415166,"y":0.41961265223274696},
{"x":0.3824331696672122,"y":0.4554719215155616},
{"x":0.3376977632296781,"y":0.4893014208389716},
{"x":0.2967812329514457,"y":0.5048629905277402},
{"x":0.2509547190398254,"y":0.5190713802435725},
{"x":0.20403709765411893,"y":0.5501945196211097},
{"x":0.1756683033278778,"y":0.5887601488497971},
{"x":0.18876159301691217,"y":0.6455937077131259},
{"x":0.23349699945444624,"y":0.6652148173207038},
{"x":0.27714129841789414,"y":0.6516830175913396},
{"x":0.3175122749590834,"y":0.6313853179972937},
{"x":0.35951991271140205,"y":0.6070280784844384},
{"x":0.4004364429896345,"y":0.5725219891745602},
{"x":0.42825968357883254,"y":0.5420754397834913},
{"x":0.4653573376977632,"y":0.5014800405953992},
{"x":0.4915439170758319,"y":0.46765054127198924},
{"x":0.5237315875613747,"y":0.4290849120433018},
{"x":0.5613747954173486,"y":0.40269790257104193},
{"x":0.5990180032733223,"y":0.36345568335588635},
{"x":0.6377523186033823,"y":0.34045162381596755},
{"x":0.6824877250409165,"y":0.32489005412719896},
{"x":0.7255864702673214,"y":0.33639208389715836},
{"x":0.7408619749045281,"y":0.385783152909337},
{"x":0.7097654118930714,"y":0.433144451962111},
{"x":0.6715766503000545,"y":0.46359100135318},
{"x":0.629569012547736,"y":0.4865950608930988},
{"x":0.5881069285324604,"y":0.5116288903924222},
{"x":0.552645935624659,"y":0.5434286197564276},
{"x":0.5280960174577196,"y":0.5806410690121786},
{"x":0.5302782324058919,"y":0.642210757780785},
{"x":0.5575559192580469,"y":0.6861891069012179},
{"x":0.5995635570103655,"y":0.6949847767253045},
{"x":0.6415711947626841,"y":0.6713041271989174},
{"x":0.668848881614839,"y":0.6246194181326117},
{"x":0.6972176759410802,"y":0.5779347090663058},
{"x":0.729950900163666,"y":0.5319265899864682},
{"x":0.7665030005455538,"y":0.5068927604871448},
{"x":0.8090561920349154,"y":0.534632949932341},
{"x":0.8199672667757774,"y":0.5860537889039242},
{"x":0.7948717948717948,"y":0.6408575778078485},
{"x":0.7495908346972177,"y":0.6516830175913396},
{"x":0.7054009819967266,"y":0.66656799729364},
{"x":0.7092198581560283,"y":0.7132527063599459},
{"x":0.7277686852154936,"y":0.7667033152909337},
{"x":0.7026732133115112,"y":0.8194773342354534},
{"x":0.6623022367703219,"y":0.801209404600812},
{"x":0.6126568466993999,"y":0.7768521650879567},
{"x":0.5859247135842881,"y":0.8194773342354534},
{"x":0.6099290780141844,"y":0.8688684032476319},
{"x":0.6486633933442444,"y":0.8898426928281462},
{"x":0.6912165848336062,"y":0.8918724627875507},
{"x":0.7424986361156574,"y":0.8715747631935048},
{"x":0.7801418439716311,"y":0.8330091339648173},
{"x":0.7997817785051827,"y":0.7863244248985116},
{"x":0.8145117294053463,"y":0.7396397158322058},
{"x":0.8521549372613202,"y":0.6902486468200271},
{"x":0.8696126568466993,"y":0.7477587956698242},
{"x":0.8908892525913802,"y":0.7897073748308525},
{"x":0.9078014184397163,"y":0.8478941136671179},
{"x":0.8979814511729405,"y":0.902697902571042}
];

/* MUNIC√çPIOS (CASAS VERDES) */
const MUNICIPIOS_KM=[
0,35,64,69,81,88,104,136,152,171,200,213,225,238,248,262,272,324,345,366,369,
386,400,435,466,475,494,500,518,551,565,595,619,640,663,666,688,722,738,738.5
];

const MUNICIPIOS={};
MUNICIPIOS_KM.forEach(km=>{
  MUNICIPIOS[km]={tokensLeft:2};
});

  const OBJECTIVES = [

  { items:[
    {km:0,text:"Visitar Chaves"},
    {km:88,text:"Visitar Peso da R√©gua"},
    {km:238,text:"Visitar Penacova"},
    {km:619,text:"Visitar Aljustrel"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:0,text:"Visitar Chaves"},
    {km:104,text:"Visitar Lamego"},
    {km:248,text:"Visitar Vila Nova de Poiares"},
    {km:640,text:"Visitar Castro Verde"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:35,text:"Visitar Vila Pouca de Aguiar"},
    {km:172,text:"Visitar Viseu"},
    {km:271,text:"Visitar G√≥is"},
    {km:551,text:"Visitar Alc√°√ßovas"},
    {km:722,text:"Visitar S√£o Br√°s de Alportel"}
  ]},

  { items:[
    {km:64,text:"Visitar Vila Real"},
    {km:213,text:"Visitar Santa Comba D√£o"},
    {km:345,text:"Visitar Sert√£"},
    {km:565,text:"Visitar Torr√£o"},
    {km:688,text:"Visitar Ameixial"}
  ]},

  { items:[
    {km:81,text:"Visitar Santa Marta de Penagui√£o"},
    {km:225,text:"Visitar Mort√°gua"},
    {km:345,text:"Visitar Sert√£"},
    {km:595,text:"Visitar Ferreira do Alentejo"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:88,text:"Visitar Peso da R√©gua"},
    {km:238,text:"Visitar Penacova"},
    {km:366,text:"Visitar Vila de Rei"},
    {km:619,text:"Visitar Aljustrel"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:104,text:"Visitar Lamego"},
    {km:248,text:"Visitar Vila Nova de Poiares"},
    {km:386,text:"Visitar Sardoal"},
    {km:640,text:"Visitar Castro Verde"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:136,text:"Visitar Castro Daire"},
    {km:260,text:"Visitar Lous√£"},
    {km:430,text:"Visitar Ponte de S√¥r"},
    {km:666,text:"Passar pelo Km 666"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:0,text:"Partir de Chaves"},
    {km:369,text:"Chegar ao Meio da Estrada"},
    {km:738,text:"Chegar a Faro"}
  ]},

  { items:[
    {km:69,text:"Passar pelo Km 69"},
    {km:369,text:"Chegar ao Meio da Estrada"},
    {km:476,text:"Visitar Mora"},
    {km:494,text:"Visitar Coruche"},
    {km:738,text:"Chegar a Faro"}
  ]}
];

/* -------- MUNIC√çPIOS -------- */
const SPECIAL_CELLS={89:{km:738.5,final:true}};
Object.values(SPECIAL_CELLS).forEach(c=>c.tokens=2);

/* -------- ESTADO -------- */
const pawns=[pawn0,pawn1,pawn2,pawn3];
let players=[],current=0,finishOrder=0;

/* -------- POSI√á√ÉO -------- */
function placePawn(pawn,i){
 const s=[...Array(120)].map((_,i)=>({x:0.1+0.007*i,y:0.1+0.006*i}))[i];
 pawn.style.left=(s.x*board.clientWidth-6)+"px";
 pawn.style.top =(s.y*board.clientHeight-8)+"px";
 debugIndex.textContent="Index: "+i;
}

/* -------- SETUP -------- */
startBtn.onclick=()=>{
 setup.classList.add("hidden");
 names.classList.remove("hidden");
 players=[];
 let used=[],i=0;

 function next(){
  names.innerHTML="";
  if(i>=playerCount.value){
    const deck=[...OBJECTIVES].sort(()=>Math.random()-0.5);
    players.forEach(p=>p.objective=deck.pop());
    names.classList.add("hidden");
    game.classList.remove("hidden");
    objectivePanel.classList.remove("hidden");
    updateTurn();return;
  }
  const input=document.createElement("input");
  input.placeholder="Nome do Jogador";
  names.append("Jogador "+(i+1),document.createElement("br"),input,document.createElement("br"));

  [
    {id:0,cls:"car",txt:"üöó Carro"},
    {id:1,cls:"bike",txt:"üö¥ Bicicleta"},
    {id:2,cls:"moto",txt:"üèçÔ∏è Mota"},
    {id:3,cls:"walk",txt:"üö∂ A p√©"}
  ].forEach(p=>{
    if(used.includes(p.id))return;
    const b=document.createElement("button");
    b.className=p.cls;
    b.textContent=p.txt;
    b.onclick=()=>{
      used.push(p.id);
      players.push({name:input.value||"Jogador "+(i+1),pawn:p.id,pos:0,done:{},extra:[],finished:false,rank:null});
      pawns[p.id].style.display="block";
      placePawn(pawns[p.id],0);
      i++;next();
    };
    names.appendChild(b);
  });
 }
 next();
};

/* -------- TURNO -------- */
function updateTurn(){
 if(players.every(p=>p.finished)){endGame();return;}
 while(players[current].finished)current=(current+1)%players.length;
 turn.textContent="Vez de "+players[current].name;
 renderObjective(players[current]);
}

/* -------- OBJETIVO -------- */
function renderObjective(p){
 objectivePanel.innerHTML=`<div class="objective-title">üéØ Objetivo de ${p.name}</div>`;
 p.objective.items.forEach(it=>{
  objectivePanel.innerHTML+=`
   <div class="obj-item">
    <div class="marco ${p.done[it.km]?"done":""}">Km ${it.km}</div>
    <div>${it.text}</div>
   </div>`;
 });
 if(p.extra.length){
  objectivePanel.innerHTML+=`<div class="extra-title">Outras fichas</div>`;
  p.extra.forEach(k=>{
    objectivePanel.innerHTML+=`
     <div class="obj-item">
      <div class="marco">Km ${k}</div>
      <div>Ficha extra</div>
     </div>`;
  });
 }
}

/* -------- PERGUNTA -------- */
function ask(cell){
 modalText.textContent=QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
 modal.style.display="flex";

 rightBtn.onclick=()=>{
  modal.style.display="none";
  if(confirm("Aceitar ficha?")){
    if(players[current].objective.items.some(it=>it.km===cell.km))
      players[current].done[cell.km]=true;
    else players[current].extra.push(cell.km);
    if(cell.final){
      players[current].finished=true;
      players[current].rank=++finishOrder;
    }
  }
  updateTurn(); // JOGA OUTRA VEZ
 };

 wrongBtn.onclick=()=>{
  modal.style.display="none";
  current=(current+1)%players.length;
  updateTurn();
 };
}

/* -------- JOGAR -------- */
rollBtn.onclick=()=>{
 const cell=SPECIAL_CELLS[89];
 ask(cell);
};

/* -------- FIM -------- */
function endGame(){
 finalScreen.style.display="block";
 finalScreen.innerHTML="<h2>üèÜ Classifica√ß√£o Final</h2>";
 [...players].sort((a,b)=>{
   const da=Object.keys(a.done).length;
   const db=Object.keys(b.done).length;
   return db-da||a.rank-b.rank;
 }).forEach((p,i)=>{
   finalScreen.innerHTML+=`<p>${i+1}¬∫ ‚Äî ${p.name} (${Object.keys(p.done).length} objetivos)</p>`;
 });
}

});
</script>

</body>
</html>
